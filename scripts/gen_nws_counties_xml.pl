#!/usr/bin/perl

use CGI qw( escapeHTML );

if ( !-e "project.properties" ) {
    print "ERROR: you need to be in the project root directory to run this script.\n";
    exit -1;
}

my @states_entries = ();
my @states_entryValues = ();

sub process_statelist {
    my $html = `wget -O- -q http://alerts.weather.gov/`;
    $html =~ s@.*summary="Table summary@@s; # nuke the part before the table we want
    $html =~ s@.*<tbody>\s*@@s;
    $html =~ s@\s*</tbody>.*@@s; # and the part after
    $html =~ s@<!-- .*? -->\s*@@s; # remove the comments
    %seen = ();

    while ( $html =~ m@cap/(\w+?)\.php\?x=1">([^<]+)</a>@sg ) {
        my $code = $1;
        my $name = $2;
        $name =~ s/'/\\'/g;
        $name =~ s@\s+@ @g; # remove excessive whitespace
        if (!exists($seen{$code})) {
            push @states_entries, $name;
            push @states_entryValues, $code;
        }
        $seen{$code} = 1;
    }
    open STATE, ">", "res/values/states.xml";
    print STATE <<EOF1;
<?xml version="1.0" encoding="utf-8"?>
<!-- This file is generated by scripts/gen_nws_counties_xml.pl -->
<resources>

    <string-array name="preference_state_entries">
EOF1
    foreach my $entry (@states_entries) {
        my $temp = $entry; # make a copy, don't edit the original
        $temp =~ s/'/\\'/g; # Android apparently needs this
        $temp = escapeHTML($temp); # And this is just good practice in XML
        print STATE "        <item>$temp</item>\n";
    }
    print STATE <<EOF2;
    </string-array>
    <string-array name="preference_state_entryvalues">
EOF2
    foreach my $entryValue (@states_entryValues) {
        my $temp = $entryValue; # make a copy, don't edit the original
        #$temp =~ s/'/\\'/g; # Android apparently needs this
        #$temp = escapeHTML($entry); # And this is just good practice in XML
        print STATE "        <item>$temp</item>\n";
    }
    print STATE <<EOF3;
    </string-array>

</resources>
EOF3
    close STATE;
    print "Wrote res/values/states.xml.\n";
}

sub process_state {
    my $state = shift @_;
    if ( $state !~ /^[a-z]+$/ ) {
        print "Invalid state code: $state (skipped)\n";
        return;
    }

    my $html = `wget -O- -q http://alerts.weather.gov/cap/${state}.php?x=3`;

    my @entries     = ();
    my @entryValues = ();

    $html =~ s@<a name='cnlist'>.*</html>@@s; # ignore the zone list
    while ( $html =~
m@<tr>\s*?<td[^>]+>\s*?<a[^>]+>\s*?<img[^>]+>\s*?</a></td>\s*?<td[^>]+>\s*?<a[^>]+>([^<]+)</a>\s*?</td>\s*?<td[^>]+>([^<]+)</td>\s*?</tr>\s*@mg
      )
    {
        push @entries,     $2;
        push @entryValues, $1;
    }
    my $unittype = "Entire State";
    if ($state =~ /^mz/) {
        $unittype = "Entire Marine Zone";
    }
    if ($state eq "dc") {
        $unittype = "Entire District";
    }
    if (grep { $_ eq $state } qw(as gu mp um vi) ) {
        $unittype = "Entire Territory";
    }
    if ($state eq "us") {
        $unittype = "Entire Country";
    }
    if ($state eq "mzus") {
        $unittype = "All Marine Zones";
    }
    print COUNTIES <<EOF1;
    <string-array name="preference_county_entries_$state">
        <item>$unittype</item>
EOF1
    foreach my $entry (@entries) {
        my $temp = $entry; # make a copy, don't edit the original
        $temp =~ s/'/\\'/g; # Android apparently needs this
        $temp = escapeHTML($temp); # And this is just good practice in XML
        print COUNTIES "        <item>$temp</item>\n";
    }
    print COUNTIES <<EOF2;
    </string-array>
    <string-array name="preference_county_entryvalues_$state">
        <item>http://alerts.weather.gov/cap/$state.php?x=0</item>
EOF2
    foreach my $entryValue (@entryValues) {
        my $temp = $entryValue; # make a copy, don't edit the original
        $temp =~ s/'/\\'/g; # Android apparently needs this
        $temp = escapeHTML($temp); # And this is just good practice in XML
        print COUNTIES "        <item>http://alerts.weather.gov/cap/wwaatmget.php?x=$temp&amp;y=0</item>\n";
    }
    print COUNTIES <<EOF3;
    </string-array>
EOF3
    print "Processed counties from $state.\n";

}

process_statelist();

open COUNTIES, ">", "res/values/counties.xml";
print COUNTIES <<EOF1;
<?xml version="1.0" encoding="utf-8"?>
<!-- This file is generated by scripts/gen_nws_counties_xml.pl -->
<resources>

EOF1
foreach my $state (@states_entryValues) {
    process_state($state);
}
print COUNTIES <<EOF3;

</resources>
EOF3
close COUNTIES;
print "Wrote res/values/counties.xml\n";

